# Makefile –¥–ª—è —Ä–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

.PHONY: help regression-tests regression-p0 regression-p1 regression-auth regression-projects regression-ai regression-security regression-middleware regression-integration regression-performance clean-results

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED = \033[0;31m
GREEN = \033[0;32m
YELLOW = \033[1;33m
BLUE = \033[0;34m
NC = \033[0m # No Color

help: ## –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É
	@echo "$(BLUE)–†–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø–æ—Ç–æ–∫–æ–≤$(NC)"
	@echo ""
	@echo "$(YELLOW)–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:$(NC)"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  $(GREEN)%-20s$(NC) %s\n", $$1, $$2}' $(MAKEFILE_LIST)

regression-tests: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ä–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
	@echo "$(BLUE)üöÄ –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ä–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤...$(NC)"
	python run_regression_tests.py

regression-p0: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ P0 —Ç–µ—Å—Ç—ã (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ)
	@echo "$(RED)üî¥ –ó–∞–ø—É—Å–∫ P0 —Ç–µ—Å—Ç–æ–≤ (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ - –±–ª–æ–∫–∏—Ä—É—é—Ç –º—ë—Ä–∂)...$(NC)"
	pytest tests/test_regression_auth_security.py tests/test_regression_project_management.py tests/test_regression_middleware_security.py -v --tb=short

regression-p1: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ P1 —Ç–µ—Å—Ç—ã (–≤–∞–∂–Ω—ã–µ)
	@echo "$(YELLOW)üü° –ó–∞–ø—É—Å–∫ P1 —Ç–µ—Å—Ç–æ–≤ (–≤–∞–∂–Ω—ã–µ - —Ç—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è)...$(NC)"
	pytest tests/test_regression_ai_service.py tests/test_regression_critical_user_flows.py -v --tb=short

regression-auth: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
	@echo "$(BLUE)üîê –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏...$(NC)"
	pytest tests/test_regression_auth_security.py::TestAuthenticationSecurity -v --tb=short

regression-projects: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞–º–∏
	@echo "$(BLUE)üìÅ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞–º–∏...$(NC)"
	pytest tests/test_regression_project_management.py -v --tb=short

regression-ai: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã AI —Å–µ—Ä–≤–∏—Å–∞
	@echo "$(BLUE)ü§ñ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ AI —Å–µ—Ä–≤–∏—Å–∞...$(NC)"
	pytest tests/test_regression_ai_service.py -v --tb=short

regression-security: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
	@echo "$(BLUE)üîí –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏...$(NC)"
	pytest tests/test_regression_auth_security.py::TestInputValidationSecurity tests/test_regression_auth_security.py::TestCSRFSecurity tests/test_regression_auth_security.py::TestCORSecurity tests/test_regression_auth_security.py::TestSecurityHeadersMiddleware -v --tb=short

regression-middleware: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã middleware
	@echo "$(BLUE)‚öôÔ∏è  –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ middleware...$(NC)"
	pytest tests/test_regression_middleware_security.py -v --tb=short

regression-integration: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
	@echo "$(BLUE)üîó –ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤...$(NC)"
	pytest tests/test_regression_critical_user_flows.py::TestIntegrationFlows -v --tb=short

regression-performance: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
	@echo "$(BLUE)‚ö° –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏...$(NC)"
	pytest tests/test_regression_critical_user_flows.py::TestPerformanceBoundaries tests/test_regression_ai_service.py::TestAIPerformance -v --tb=short

regression-quick: ## –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
	@echo "$(YELLOW)‚ö° –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤...$(NC)"
	pytest tests/test_regression_auth_security.py::TestAuthenticationSecurity::test_password_validation_strength tests/test_regression_project_management.py::TestProjectCreationFlow::test_project_creation_success tests/test_regression_middleware_security.py::TestSecurityHeadersMiddleware::test_security_headers_presence -v --tb=short

regression-coverage: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º –∫–æ–¥–∞
	@echo "$(BLUE)üìä –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º –∫–æ–¥–∞...$(NC)"
	pytest tests/test_regression_*.py --cov=backend --cov-report=html:htmlcov --cov-report=term-missing --cov-fail-under=70 -v

regression-parallel: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
	@echo "$(BLUE)üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ...$(NC)"
	pytest tests/test_regression_*.py -n auto -v --tb=short

regression-debug: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã –≤ —Ä–µ–∂–∏–º–µ –æ—Ç–ª–∞–¥–∫–∏
	@echo "$(BLUE)üêõ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –≤ —Ä–µ–∂–∏–º–µ –æ—Ç–ª–∞–¥–∫–∏...$(NC)"
	pytest tests/test_regression_*.py -v --tb=long --capture=no --log-cli-level=DEBUG

regression-verbose: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –≤—ã–≤–æ–¥–æ–º
	@echo "$(BLUE)üìù –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –≤—ã–≤–æ–¥–æ–º...$(NC)"
	pytest tests/test_regression_*.py -v --tb=long --capture=no

regression-failed: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
	@echo "$(BLUE)üîÑ –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤...$(NC)"
	pytest tests/test_regression_*.py --lf -v --tb=short

regression-stop-on-first-fail: ## –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –Ω–∞ –ø–µ—Ä–≤–æ–π –æ—à–∏–±–∫–µ
	@echo "$(BLUE)‚èπÔ∏è  –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å –æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π –Ω–∞ –ø–µ—Ä–≤–æ–π –æ—à–∏–±–∫–µ...$(NC)"
	pytest tests/test_regression_*.py -x -v --tb=short

regression-marks: ## –ü–æ–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã
	@echo "$(BLUE)üè∑Ô∏è  –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã:$(NC)"
	pytest --markers | grep -E "(p0|p1|auth|security|project|ai|middleware|integration|performance)"

regression-list: ## –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
	@echo "$(BLUE)üìã –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤:$(NC)"
	pytest tests/test_regression_*.py --collect-only -q

regression-html: ## –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML –æ—Ç—á—ë—Ç–∞
	@echo "$(BLUE)üìÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML –æ—Ç—á—ë—Ç–∞...$(NC)"
	pytest tests/test_regression_*.py --html=regression_report.html --self-contained-html -v

regression-xml: ## –ì–µ–Ω–µ—Ä–∞—Ü–∏—è XML –æ—Ç—á—ë—Ç–∞ –¥–ª—è CI/CD
	@echo "$(BLUE)üìÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è XML –æ—Ç—á—ë—Ç–∞...$(NC)"
	pytest tests/test_regression_*.py --junitxml=regression_results.xml -v

clean-results: ## –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤
	@echo "$(YELLOW)üßπ –û—á–∏—Å—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–æ–≤...$(NC)"
	rm -f test_results.json
	rm -f regression_test_results_*.json
	rm -f REGRESSION_TEST_SUMMARY.md
	rm -f regression_tests.log
	rm -f regression_report.html
	rm -f regression_results.xml
	rm -rf htmlcov/
	rm -rf .pytest_cache/
	rm -rf __pycache__/
	find . -name "*.pyc" -delete
	find . -name "*.pyo" -delete

install-deps: ## –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
	@echo "$(BLUE)üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...$(NC)"
	pip install pytest pytest-cov pytest-html pytest-xdist pytest-timeout pytest-json-report
	pip install -r requirements.txt
	pip install -r requirements-dev.in

check-deps: ## –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
	@echo "$(BLUE)üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...$(NC)"
	python -c "import pytest; print('pytest:', pytest.__version__)"
	python -c "import pytest_cov; print('pytest-cov: OK')"
	python -c "import pytest_html; print('pytest-html: OK')"
	python -c "import pytest_xdist; print('pytest-xdist: OK')"
	python -c "import pytest_timeout; print('pytest-timeout: OK')"

validate-tests: ## –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
	@echo "$(BLUE)‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤...$(NC)"
	python -m py_compile tests/test_regression_*.py
	@echo "$(GREEN)‚úÖ –í—Å–µ —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã –≤–∞–ª–∏–¥–Ω—ã$(NC)"

# –ê–ª–∏–∞—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
test: regression-tests
test-p0: regression-p0
test-p1: regression-p1
test-auth: regression-auth
test-projects: regression-projects
test-ai: regression-ai
test-security: regression-security
test-middleware: regression-middleware
test-integration: regression-integration
test-performance: regression-performance
test-quick: regression-quick
test-coverage: regression-coverage
test-parallel: regression-parallel
test-debug: regression-debug
test-verbose: regression-verbose
test-failed: regression-failed
test-stop: regression-stop-on-first-fail
test-html: regression-html
test-xml: regression-xml
clean: clean-results
install: install-deps
check: check-deps
validate: validate-tests

# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø—Ä–∞–≤–∫—É
.DEFAULT_GOAL := help