# План безопасной эволюции API без Breaking Changes

## Обзор

План поэтапной синхронизации OpenAPI спецификации с фактической реализацией, обеспечивающий обратную совместимость.

## Фаза 1: Добавление отсутствующих эндпоинтов (Критично)

### 1.1 MFA (Multi-Factor Authentication)
**Приоритет**: Критично
**Статус**: Отсутствует в спецификации
**Действия**:
- Добавить эндпоинты в спецификацию
- Создать схемы данных для MFA
- Добавить тесты

**Эндпоинты для добавления**:
```yaml
/api/auth/mfa/setup:
  post:
    summary: Setup MFA
    description: Настройка двухфакторной аутентификации
    responses:
      '200':
        description: MFA setup successful
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MFASetupResponse'

/api/auth/mfa/verify:
  post:
    summary: Verify MFA code
    description: Проверка MFA кода
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/MFAVerifyRequest'
    responses:
      '200':
        description: MFA verification result
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MFAVerifyResponse'

/api/auth/mfa/disable:
  delete:
    summary: Disable MFA
    description: Отключение MFA
    responses:
      '200':
        description: MFA disabled successfully
```

### 1.2 RBAC (Role-Based Access Control)
**Приоритет**: Критично
**Статус**: Отсутствует в спецификации
**Действия**:
- Добавить все RBAC эндпоинты
- Создать схемы для ролей и разрешений
- Добавить тесты

### 1.3 API Keys Management
**Приоритет**: Критично
**Статус**: Отсутствует в спецификации
**Действия**:
- Добавить эндпоинты управления API ключами
- Создать схемы для API ключей
- Добавить тесты

### 1.4 Дополнительные Health Check эндпоинты
**Приоритет**: Высокий
**Статус**: Частично отсутствует
**Действия**:
- Добавить `/api/health/database`
- Добавить `/api/health/ai`
- Добавить `/api/health/system`

## Фаза 2: Синхронизация существующих эндпоинтов

### 2.1 Аутентификация
**Проблема**: Дублирование эндпоинтов
**Решение**:
- Удалить `/api/auth/me` из спецификации
- Оставить только `/api/auth/user`
- Синхронизировать LoginResponse схему

### 2.2 AI эндпоинты
**Проблема**: Отсутствует streaming в main.py
**Решение**:
- Подключить `/api/ai/chat/stream` к main.py
- Унифицировать AI response схемы

### 2.3 Проекты
**Проблема**: PUT эндпоинт не подключен
**Решение**:
- Подключить PUT `/api/projects/{project_id}` к main.py
- Синхронизировать ProjectResponse схему

## Фаза 3: Улучшения и стандартизация

### 3.1 Схемы данных
**Действия**:
- Стандартизировать error responses
- Добавить метрики в ProjectResponse
- Улучшить валидацию

### 3.2 Документация
**Действия**:
- Добавить примеры запросов/ответов
- Улучшить описания эндпоинтов
- Добавить коды ошибок

## Стратегия миграции

### Backward Compatibility
1. **Не удалять** существующие эндпоинты
2. **Добавлять** новые поля как optional
3. **Deprecate** старые поля с предупреждением
4. **Версионировать** API при необходимости

### Версионирование
- **v1.0.0**: Текущая версия
- **v1.1.0**: Добавление MFA, RBAC, API Keys
- **v1.2.0**: Синхронизация существующих эндпоинтов
- **v2.0.0**: Breaking changes (если потребуются)

### Тестирование
1. **Contract Tests**: Проверка соответствия спецификации
2. **Integration Tests**: Проверка работы эндпоинтов
3. **Regression Tests**: Проверка обратной совместимости

## Риски и митигация

### Риск 1: Breaking Changes
**Митигация**: Тщательное тестирование, постепенная миграция

### Риск 2: Производительность
**Митигация**: Мониторинг, нагрузочное тестирование

### Риск 3: Безопасность
**Митигация**: Security review, penetration testing

## Метрики успеха

1. **100%** покрытие эндпоинтов в спецификации
2. **0** breaking changes
3. **100%** прохождение contract tests
4. **<100ms** среднее время ответа
5. **99.9%** uptime

## Временные рамки

- **Фаза 1**: 2 недели
- **Фаза 2**: 1 неделя  
- **Фаза 3**: 1 неделя
- **Тестирование**: 1 неделя
- **Деплой**: 1 неделя

**Общий срок**: 6 недель