#!/usr/bin/env python3
"""
Final Security Test
–§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
"""

import re
from pathlib import Path

def test_specific_fixes():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è"""
    
    print("üîí –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò")
    print("=" * 60)
    
    tests_passed = 0
    total_tests = 0
    
    # –¢–µ—Å—Ç 1: JWT –≤–∞–ª–∏–¥–∞—Ü–∏—è
    print("\n1. –ü—Ä–æ–≤–µ—Ä–∫–∞ JWT –≤–∞–ª–∏–¥–∞—Ü–∏–∏...")
    total_tests += 1
    
    deps_file = Path("backend/auth/dependencies.py")
    if deps_file.exists():
        content = deps_file.read_text()
        if "def validate_jwt_token" in content and "jwt.decode" in content and "payload['exp']" in content:
            print("‚úÖ JWT –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞")
            tests_passed += 1
        else:
            print("‚ùå JWT –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞")
    else:
        print("‚ùå –§–∞–π–ª auth/dependencies.py –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    # –¢–µ—Å—Ç 2: –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π
    print("\n2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π...")
    total_tests += 1
    
    if deps_file.exists():
        content = deps_file.read_text()
        if "def hash_password" in content and "pbkdf2_hmac" in content and "def verify_password" in content:
            print("‚úÖ –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ")
            tests_passed += 1
        else:
            print("‚ùå –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ")
    
    # –¢–µ—Å—Ç 3: CSRF –∑–∞—â–∏—Ç–∞
    print("\n3. –ü—Ä–æ–≤–µ—Ä–∫–∞ CSRF –∑–∞—â–∏—Ç—ã...")
    total_tests += 1
    
    main_file = Path("backend/main.py")
    if main_file.exists():
        content = main_file.read_text()
        if "csrf_protect" in content and "X-CSRF-Token" in content and "validate_csrf_token" in content:
            print("‚úÖ CSRF –∑–∞—â–∏—Ç–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞")
            tests_passed += 1
        else:
            print("‚ùå CSRF –∑–∞—â–∏—Ç–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞")
    
    # –¢–µ—Å—Ç 4: –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è CORS
    print("\n4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π CORS...")
    total_tests += 1
    
    if main_file.exists():
        content = main_file.read_text()
        if "allowed_origins" in content and 'allow_headers=["*"]' not in content:
            print("‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è CORS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è")
            tests_passed += 1
        else:
            print("‚ùå –ù–µ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è CORS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è")
    
    # –¢–µ—Å—Ç 5: –ó–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    print("\n5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏...")
    total_tests += 1
    
    if main_file.exists():
        content = main_file.read_text()
        security_headers = ["X-Content-Type-Options", "X-Frame-Options", "X-XSS-Protection", "Strict-Transport-Security"]
        if all(header in content for header in security_headers):
            print("‚úÖ –ó–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã")
            tests_passed += 1
        else:
            print("‚ùå –ó–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã")
    
    # –¢–µ—Å—Ç 6: –ó–∞—â–∏—Ç–∞ –æ—Ç SQL –∏–Ω—ä–µ–∫—Ü–∏–π
    print("\n6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—â–∏—Ç—ã –æ—Ç SQL –∏–Ω—ä–µ–∫—Ü–∏–π...")
    total_tests += 1
    
    validator_file = Path("backend/validators/secure_input_validator.py")
    if validator_file.exists():
        content = validator_file.read_text()
        if "SQL_INJECTION_PATTERNS" in content and "union" in content and "select" in content:
            print("‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç SQL –∏–Ω—ä–µ–∫—Ü–∏–π —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞")
            tests_passed += 1
        else:
            print("‚ùå –ó–∞—â–∏—Ç–∞ –æ—Ç SQL –∏–Ω—ä–µ–∫—Ü–∏–π –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞")
    
    # –¢–µ—Å—Ç 7: –ó–∞—â–∏—Ç–∞ –æ—Ç XSS
    print("\n7. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—â–∏—Ç—ã –æ—Ç XSS...")
    total_tests += 1
    
    if validator_file.exists():
        content = validator_file.read_text()
        if "XSS_PATTERNS" in content and "bleach" in content and "script" in content:
            print("‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç XSS —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞")
            tests_passed += 1
        else:
            print("‚ùå –ó–∞—â–∏—Ç–∞ –æ—Ç XSS –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞")
    
    # –¢–µ—Å—Ç 8: –°—Ç—Ä–æ–≥–∏–π rate limiting
    print("\n8. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä–æ–≥–æ–≥–æ rate limiting...")
    total_tests += 1
    
    rate_limiter_file = Path("backend/middleware/secure_rate_limiter.py")
    if rate_limiter_file.exists():
        content = rate_limiter_file.read_text()
        if "auth_limits" in content and "3" in content and "900" in content:
            print("‚úÖ –°—Ç—Ä–æ–≥–∏–π rate limiting —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω")
            tests_passed += 1
        else:
            print("‚ùå –°—Ç—Ä–æ–≥–∏–π rate limiting –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω")
    
    # –¢–µ—Å—Ç 9: –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    print("\n9. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è...")
    total_tests += 1
    
    error_handler_file = Path("backend/middleware/secure_error_handler.py")
    if error_handler_file.exists():
        content = error_handler_file.read_text()
        if "sanitize_error_message" in content and "REDACTED" in content:
            print("‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ")
            tests_passed += 1
        else:
            print("‚ùå –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ")
    
    # –¢–µ—Å—Ç 10: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π —É—è–∑–≤–∏–º–æ—Å—Ç–∏ —Å supabase
    print("\n10. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–∏ —Å supabase...")
    total_tests += 1
    
    if deps_file.exists():
        content = deps_file.read_text()
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è
        if "supabase_client = connection_manager.get_pool('supabase')" in content and "if not supabase_client:" in content:
            print("‚úÖ –£—è–∑–≤–∏–º–æ—Å—Ç—å —Å –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞")
            tests_passed += 1
        else:
            print("‚ùå –£—è–∑–≤–∏–º–æ—Å—Ç—å —Å –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –ù–ï –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞")
    
    # –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
    print("\n" + "=" * 60)
    print(f"üìä –ò–¢–û–ì–û–í–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´:")
    print(f"‚úÖ –ü—Ä–æ–π–¥–µ–Ω–æ: {tests_passed}/{total_tests}")
    print(f"‚ùå –ü—Ä–æ–≤–∞–ª–µ–Ω–æ: {total_tests - tests_passed}/{total_tests}")
    
    if tests_passed == total_tests:
        print("\nüéâ –í–°–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–ò–ú–ï–ù–ï–ù–´ –ö–û–†–†–ï–ö–¢–ù–û!")
        print("üîí –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã")
        return True
    else:
        print(f"\n‚ö†Ô∏è  –ù–ï–ö–û–¢–û–†–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ù–ï –ü–†–ò–ú–ï–ù–ï–ù–´")
        print(f"–ü—Ä–æ–≤–∞–ª–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤: {total_tests - tests_passed}")
        return False

if __name__ == "__main__":
    success = test_specific_fixes()
    exit(0 if success else 1)